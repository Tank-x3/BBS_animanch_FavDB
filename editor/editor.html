<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fav-DB Editor</title>
    <link rel="stylesheet" href="../shared/css/base.css">
    <link rel="stylesheet" href="css/editor.css">
</head>

<body>
    <header>
        <h1>Fav-DB Editor</h1>
        <div class="header-buttons">
            <button id="tag-management-button" disabled>タグ管理</button>
            <button id="export-html-button" disabled>共有用HTMLをエクスポート</button>
            <button id="save-button" disabled>保存 (JSON)</button>
            <button id="help-button">ヘルプ</button>
        </div>
    </header>

    <main>
        <div id="file-drop-area">
            <p>データベースファイル (fav_database.json) をここにドラッグ＆ドロップするか、クリックして選択</p>
            <input type="file" id="file-input" accept=".json" style="display: none;">
        </div>

        <div id="controls" class="hidden">
            <div class="control-group">
                <label for="keyword-search">キーワード:</label>
                <input type="text" id="keyword-search" placeholder="タイトルで検索...">
            </div>
            <div class="control-group">
                <label>フィルタ:</label>
                <div class="tag-filter-container">
                    <select id="tag-filter-mode">
                        <option value="AND" selected>AND</option>
                        <option value="OR">OR</option>
                    </select>
                    <div id="tag-multiselect" class="multiselect">
                        <div class="select-box">
                            <span class="placeholder">タグを選択</span>
                        </div>
                        <div id="tag-checkboxes" class="checkboxes">
                            <!-- JavaScriptでタグリストが挿入されます -->
                        </div>
                    </div>
                </div>
                <label class="checkbox-label"><input type="checkbox" id="filter-untagged"> 未分類のみ</label>
                <label class="checkbox-label"><input type="checkbox" id="filter-nodesc"> 説明未記入のみ</label>
                <button id="toggle-all-details">全て展開</button>
                <button id="reset-filter">リセット</button>
            </div>
        </div>

        <div id="batch-edit-bar" class="hidden">
            <label class="checkbox-label"><input type="checkbox" id="select-all-checkbox"> すべて選択/解除</label>
            <button id="batch-edit-button" disabled>選択した0件を一括編集</button>
        </div>

        <div id="data-container">
            <table id="data-table">
                <thead>
                    <tr>
                        <th class="col-select"></th>
                        <th class="col-no">No.</th>
                        <th class="col-datetime sortable" data-sort="user_timestamp">日時</th>
                        <th class="col-title sortable" data-sort="title">タイトル</th>
                        <th class="col-tags">タグ</th>
                        <th class="col-actions">編集</th>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
            <div id="card-list"></div>
        </div>

        <div id="pagination" class="hidden"></div>
    </main>

    <footer>
        <p id="status-bar">ファイルが読み込まれていません。</p>
    </footer>

    <!-- Modals -->
    <div id="help-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <span class="modal-close-button">&times;</span>
            <h2>ヘルプ</h2>
            <div class="modal-body">
                <h3>基本的な使い方 (全体の流れ)</h3>
                <ol>
                    <li><strong>データ抽出:</strong> まず「抽出ツール
                        (`importer.html`)」を使って、お気に入りページ（`html`/`mht`ファイル）からデータベースファイル（`fav_database.json`）を作成または更新します。
                    </li>
                    <li><strong>データ読込:</strong> この編集ツールで`fav_database.json`を読み込みます。（ドラッグ＆ドロップでも可）</li>
                    <li><strong>編集:</strong> データを検索・フィルタリングし、タグや説明文を編集します。</li>
                    <li><strong>保存:</strong> 編集が終わったら、右上の「<strong>保存 (JSON)</strong>」ボタンを押し、更新されたファイルをダウンロードします。</li>
                    <li><strong>上書き:</strong> ダウンロードした新しいファイルで、元の`fav_database.json`を上書き保存してください。</li>
                </ol>
                <h3>データの検索・フィルタリング</h3>
                <ul>
                    <li><strong>キーワード検索:</strong> タイトルに含まれる言葉でスレッドを絞り込めます。入力するたびに結果が更新されます。</li>
                    <li><strong>タグ検索:</strong>
                        <ul>
                            <li>複数タグを選択して、それら「すべてを含む(AND)」か「いずれかを含む(OR)」スレッドを検索できます。</li>
                            <li><strong>[未分類のみ]</strong>: タグが一つも付いていないスレッドだけを表示します。</li>
                        </ul>
                    </li>
                    <li><strong>説明文フィルタ:</strong> <strong>[説明未記入のみ]</strong>: 説明文がまだ入力されていないスレッドだけを表示します。</li>
                    <li><strong>リセット:</strong> すべての検索条件を解除し、全件表示に戻します。</li>
                </ul>
                <h3>データの編集方法</h3>
                <p><strong>メインの編集方法: 編集モーダル</strong></p>
                <ul>
                    <li>各行の <svg class="icon-inline" viewBox="0 0 24 24">
                            <path
                                d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 00-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z">
                            </path>
                        </svg> ボタンを押すと、編集画面が開きます。</li>
                    <li><strong>連続編集:</strong> 画面内の <strong>[←前へ]</strong> / <strong>[次へ→]</strong>
                        ボタンで、現在一覧に表示されている（フィルタリング後の）順番で、前後のスレッドの編集に素早く移ることができます。</li>
                    <li><strong>新規タグ:</strong> カンマ(<code>,</code>)区切りで複数のタグを一度に追加できます。</li>
                </ul>
                <p><strong>補足: その他の操作</strong></p>
                <ul>
                    <li><strong>インライン編集:</strong> 各行の「日時」「説明文」「タグの[+]ボタン」を直接クリックすることでも、素早く編集できます。</li>
                    <li><strong>説明文の表示:</strong> 各行のボタン、または「全て展開/畳む」ボタンで、説明文の表示を切り替えられます。</li>
                </ul>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-nav">
                <button id="modal-prev" disabled>&leftarrow; 前へ</button>
                <span id="modal-counter"></span>
                <button id="modal-next" disabled>次へ &rightarrow;</button>
            </div>
            <div class="modal-body">
                <p><strong>タイトル:</strong> <a id="modal-title" href="#" target="_blank"></a></p>
                <label for="modal-datetime">日時:</label>
                <input type="text" id="modal-datetime">
                <details id="modal-tags-details">
                    <summary>タグ: <span id="modal-tags-summary"></span></summary>
                    <div id="modal-tags-container" class="modal-tags-container"></div>
                    <input type="text" id="modal-new-tag" placeholder="新規タグをカンマ区切りで入力...">
                </details>
                <label for="modal-description">説明:</label>
                <textarea id="modal-description" rows="8"></textarea>
            </div>
            <div class="modal-footer">
                <button id="modal-close">閉じる</button>
            </div>
        </div>
    </div>

    <div id="batch-edit-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>タグの一括編集</h2>
            </div>
            <div class="modal-body">
                <p id="batch-edit-info"></p>
                <div class="batch-edit-section">
                    <details>
                        <summary>これらのタグを【追加】: <span class="selected-tags-summary"></span></summary>
                        <div class="tag-checkbox-list" id="batch-add-tags-list"></div>
                    </details>
                </div>
                <div class="batch-edit-section">
                    <details>
                        <summary>これらのタグを【削除】: <span class="selected-tags-summary"></span></summary>
                        <div class="tag-checkbox-list" id="batch-remove-tags-list"></div>
                    </details>
                </div>
            </div>
            <div class="modal-footer">
                <button id="batch-edit-cancel">キャンセル</button>
                <button id="batch-edit-execute">実行</button>
            </div>
        </div>
    </div>

    <div id="tag-management-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>タグ管理</h2>
            </div>
            <div class="modal-body">
                <table id="tag-management-table">
                    <thead>
                        <tr>
                            <th>タグ名</th>
                            <th>使用数</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button id="tag-management-close">閉じる</button>
            </div>
        </div>
    </div>

    <script src="../shared/js/constants.js"></script>
    <script src="../shared/js/utils.js"></script>
    <script src="modules/state.js"></script>
    <script src="modules/renderer.js"></script>
    <script src="modules/filters.js"></script>
    <script src="modules/handler.js"></script>
    <script src="modules/main.js?v=0.1"></script>
</body>

</html>